name: Lightweight Backfill Engine

on:
  # æ‰‹å‹•å®Ÿè¡Œã®ã¿ã‚’è¨±å¯ï¼ˆæ—¥æ¬¡cronã‚¸ãƒ§ãƒ–ã¨ã¯å®Œå…¨ã«åˆ†é›¢ï¼‰
  workflow_dispatch:

permissions:
  contents: write

jobs:
  run-backfill:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Run Backfill Engine
        # backfill.py å†…ã§æŒ‡å®šã•ã‚ŒãŸæ—¥æ•°ï¼ˆç¾åœ¨ã¯10å–¶æ¥­æ—¥ï¼‰ã®éå»ãƒ‡ãƒ¼ã‚¿ã‚’ä¸€æ°—ã«ç”Ÿæˆ
        run: python backfill.py

      # ã€æœ€é‡è¦ã€‘ç”Ÿæˆã•ã‚ŒãŸå±¥æ­´JSONã‚’ main ãƒ–ãƒ©ãƒ³ãƒã«ä¿å­˜ã—ã¦æ°¸ç¶šåŒ–ã™ã‚‹
      - name: Commit and Push History to Main
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add public/history/*.json
          # å¤‰æ›´ãŒã‚ã‚‹å ´åˆã®ã¿ã‚³ãƒŸãƒƒãƒˆã—ã¦ãƒ—ãƒƒã‚·ãƒ¥ï¼ˆã‚¨ãƒ©ãƒ¼å›é¿ï¼‰
          git diff --quiet && git diff --staged --quiet || (git commit -m "ğŸš€ [Backfill] éå»ã®å±¥æ­´ãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆ" && git push)

      # ãƒãƒƒã‚¯ãƒ•ã‚£ãƒ«ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’ GitHub Pagesï¼ˆWebè¡¨ç¤ºï¼‰å´ã«ã‚‚åæ˜ 
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public
          keep_files: true # æ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¶ˆã•ãšã«è¿½åŠ ãƒ»ä¸Šæ›¸ã
